<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Mark Attendance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }

        .page-wrapper {
            max-width: 1400px;
            margin: auto;
            padding: 30px;
        }

        .video-frame {
            border: 3px dashed #0d6efd;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        #videoElement {
            width: 100%;
            border-radius: 10px;
        }

        #overlayCanvas {
            position: absolute;
            inset: 0;
        }

        .stat-card {
            border-radius: 15px;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .stat-total {
            background: linear-gradient(135deg, #6f42c1, #9b59b6);
        }

        .stat-present {
            background: linear-gradient(135deg, #198754, #2ecc71);
        }

        .stat-absent {
            background: linear-gradient(135deg, #dc3545, #ff6b6b);
        }

        .stat-percent {
            background: linear-gradient(135deg, #0d6efd, #4dabf7);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="page-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <a href="{% url 'home' %}" class="btn btn-outline-primary">â¬… Home</a>
            <h2 class="fw-bold text-primary">Mark Attendance</h2>
        </div>

        <div class="row g-4">
            <div class="col-sm-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white fw-semibold">
                        ðŸ“· Live Face Recognition
                    </div>
                    <div class="card-body text-center">

                        <div class="video-frame mb-3">
                            <video id="videoElement" autoplay muted playsinline></video>
                            <canvas id="overlayCanvas"></canvas>
                        </div>

                        <div id="status" class="alert alert-info">
                            Waiting for face...
                        </div>

                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <div class="stat-card stat-total">
                            <div>Total Students</div>
                            <div class="stat-value">{{ stats.total_students }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card stat-present">
                            <div>Present</div>
                            <div class="stat-value">{{ stats.present }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card stat-absent">
                            <div>Absent</div>
                            <div class="stat-value">{{ stats.absent }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-card stat-percent">
                            <div>Attendance %</div>
                            <div class="stat-value">
                                {{ stats.attendance_percentage|floatformat:1 }}%
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="resetTodayAttendance()" class="btn btn-danger w-100">
                    ðŸ”„ Reset Today Attendance
                </button>

            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

        <script>
            let video, canvas, ctx, stream;
            let detectionInterval = null;
            let modelsLoaded = false;
            let faceStableCount = 0;
            let attendanceDone = false;
            let attendanceInProgress = false;

            async function loadModels() {
                const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                modelsLoaded = true;
            }

            function startWebcam() {
                video = document.getElementById('videoElement');
                canvas = document.getElementById('overlayCanvas');
                ctx = canvas.getContext('2d');

                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(s => {
                        stream = s;
                        video.srcObject = stream;
                        video.play();

                        video.onloadedmetadata = async () => {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            await loadModels();
                            startDetection();
                        };
                    })
                    .catch(err => {
                        document.getElementById('status').className = 'alert alert-danger';
                        document.getElementById('status').innerText = 'Camera error: ' + err.message;
                    });
            }

            function startDetection() {
                detectionInterval = setInterval(async () => {
                    if (!modelsLoaded || attendanceDone) return;

                    const detections = await faceapi.detectAllFaces(
                        video,
                        new faceapi.TinyFaceDetectorOptions()
                    );

                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (detections.length > 0) {
                        faceStableCount++;

                        detections.forEach(d => {
                            const b = d.box;
                            ctx.strokeStyle = '#00ff00';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(b.x, b.y, b.width, b.height);
                        });

                        if (faceStableCount >= 6 && !attendanceInProgress) {
                            attendanceInProgress = true;
                            recognizeFaceAuto();
                        }
                    } else {
                        faceStableCount = 0;
                    }
                }, 150);
            }

            function recognizeFaceAuto() {
                const snap = document.createElement('canvas');
                snap.width = video.videoWidth;
                snap.height = video.videoHeight;
                snap.getContext('2d').drawImage(video, 0, 0);

                const imageData = snap.toDataURL('image/jpeg');
                const status = document.getElementById('status');

                status.className = 'alert alert-warning';
                status.innerText = 'Recognizing face...';

                fetch('{% url "mark_attendance_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ image: imageData })
                })
                    .then(r => r.json())
                    .then(data => {
                        attendanceInProgress = false;

                        if (data.success) {
                            attendanceDone = true;
                            clearInterval(detectionInterval);

                            status.className = 'alert alert-success';
                            status.innerHTML = `âœ… Attendance Marked<br><b>${data.student_name}</b>`;

                            setTimeout(() => location.reload(), 3000);
                        } else {
                            status.className = 'alert alert-info';
                            status.innerText = data.error || 'No match yet';
                        }
                    })
                    .catch(err => {
                        attendanceInProgress = false;
                        status.className = 'alert alert-danger';
                        status.innerText = err.message;
                    });
            }

            function resetTodayAttendance() {
                fetch('{% url "reset_attendance_today_api" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                }).then(() => location.reload());
            }

            function getCookie(name) {
                return document.cookie.split('; ')
                    .find(r => r.startsWith(name + '='))?.split('=')[1];
            }

            window.onload = startWebcam;
            window.onbeforeunload = () => stream && stream.getTracks().forEach(t => t.stop());
        </script>

</body>

</html>